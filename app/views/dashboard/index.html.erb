<% content_for :header_tags do %>
  <%= stylesheet_link_tag 'dashboard', plugin: 'redmine_dashboard_pro' %>
  <%= javascript_include_tag 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js' %>
  <%= javascript_include_tag 'dashboard', :plugin => 'redmine_dashboard_pro' %>
<% end %>

<div class="dashboard-container">
  <div class="dashboard-header">
    <h1><%= l(:label_dashboard) %></h1>
    <div class="project-selector">
      <%= form_tag dashboard_index_path, method: :get, local: true, id: 'project-selector-form' do %>
        <%= label_tag :project_id, l(:field_project) %>
        <%= select_tag :project_id, 
            options_for_select([['All Projects', '']] + @projects.collect{ |p| [p.name, p.id] }, @current_project&.id),
            { onchange: 'Dashboard.switchProject(this.value)',
              class: 'project-select' } %>
      <% end %>
    </div>
  </div>

  <!-- Overview Cards -->
  <div class="overview-cards">
    <div class="card">
      <div class="card-content">
        <div class="card-title"><%= l(:label_project_plural) %></div>
        <div class="card-value" id="total-projects"><%= @statistics.total_projects %></div>
      </div>
      <div class="card-icon projects"></div>
    </div>
    
    <div class="card">
      <div class="card-content">
        <div class="card-title"><%= l(:label_issue_plural) %></div>
        <div class="card-value" id="total-issues"><%= @statistics.total_issues %></div>
      </div>
      <div class="card-icon issues"></div>
    </div>
    
    <div class="card">
      <div class="card-content">
        <div class="card-title"><%= l(:label_user_plural) %></div>
        <div class="card-value" id="total-users"><%= @statistics.total_users %></div>
      </div>
      <div class="card-icon users"></div>
    </div>
    
    <div class="card">
      <div class="card-content">
        <div class="card-title"><%= l(:label_spent_time) %></div>
        <div class="card-value" id="total-time"><%= format_time_duration(@statistics.total_time_spent) %></div>
      </div>
      <div class="card-icon time"></div>
    </div>
  </div>

  <!-- Main Dashboard Grid -->
  <div class="dashboard-grid">
    
    <!-- Issues Overview -->
    <div class="widget large">
      <h3><%= l(:label_issue_plural) %> <%= l(:label_overview) %></h3>
      <div class="widget-content large">
        <div class="issue-stats">
          <div class="stat-item">
            <span class="stat-label"><%= l(:field_status) %>:</span>
            <div class="stat-bars">
              <div class="stat-bar open">
                <span>Open: <%= @statistics.open_issues %></span>
                <div class="bar" style="width: <%= (@statistics.total_issues > 0 ? (@statistics.open_issues.to_f / @statistics.total_issues * 100) : 0).round %>%"></div>
              </div>
              <div class="stat-bar closed">
                <span>Closed: <%= @statistics.closed_issues %></span>
                <div class="bar" style="width: <%= (@statistics.total_issues > 0 ? (@statistics.closed_issues.to_f / @statistics.total_issues * 100) : 0).round %>%"></div>
              </div>
            </div>
          </div>
          <div class="completion-rate">
            <h4>Completion Rate</h4>
            <%= progress_bar(@statistics.completion_rate) %>
          </div>
        </div>
        <canvas id="issueStatusChart" width="400" height="200"></canvas>
      </div>
    </div>

    <!-- Project Progress (if specific project selected) -->
    <% if @current_project %>
    <div class="widget large">
      <h3><%= @current_project.name %> Progress</h3>
      <div class="widget-content">
        <% progress = @statistics.project_progress %>
        <div class="progress-overview">
          <p><strong>Total Issues:</strong> <%= progress[:total_issues] %></p>
          <p><strong>Closed:</strong> <%= progress[:closed_issues] %></p>
          <%= progress_bar(progress[:progress_percentage]) %>
          <p><strong>Time Logged:</strong> <%= format_time_duration(progress[:estimated_hours]) %></p>
        </div>
      </div>
    </div>
    <% end %>

    <!-- Time Tracking -->
    <div class="widget large">
      <h3><%= l(:label_spent_time) %></h3>
      <div class="widget-content">
        <div class="time-stats">
          <p><strong>This Week:</strong> <%= format_time_duration(@statistics.time_spent_this_week) %></p>
          <p><strong>This Month:</strong> <%= format_time_duration(@statistics.time_spent_this_month) %></p>
        </div>
        <canvas id="timeTrackingChart" width="300" height="200"></canvas>
      </div>
    </div>

    <!-- Recent Issues -->
    <div class="widget large">
      <h3><%= l(:label_issue_plural) %> - Recent</h3>
      <div class="widget-content">
        <div class="recent-issues" id="recent-issues">
          <% @statistics.recent_issues(5).each do |issue| %>
          <div class="issue-item">
            <div class="issue-header">
              <%= link_to "##{issue[:id]}", issue_path(issue[:id]), class: 'issue-link' %>
              <%= status_badge(issue[:status]) %>
              <%= priority_icon(issue[:priority]) %>
            </div>
            <div class="issue-subject"><%= truncate(issue[:subject], length: 60) %></div>
            <div class="issue-meta">
              <span class="assignee"><%= issue[:assignee] || 'Unassigned' %></span>
              <span class="date"><%= time_ago_in_words(issue[:updated_on]) %> ago</span>
            </div>
          </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- User Activity -->
    <div class="widget large">
      <h3><%= l(:label_user_plural) %> Activity</h3>
      <div class="widget-content">
        <div class="activity-stats">
          <p><strong>Active Users (30 days):</strong> <span id="active-users"><%= @statistics.active_users %></span></p>
        </div>
        <canvas id="userActivityChart" width="300" height="200"></canvas>
      </div>
    </div>

    <!-- Issue Distribution -->
    <div class="widget large">
      <h3>Issue Distribution</h3>
      <div class="widget-content">
        <canvas id="issueDistributionChart" width="300" height="300"></canvas>
      </div>
    </div>

    <!-- Recent Activity Feed -->
    <div class="widget large">
      <h3>Recent Activity</h3>
      <div class="widget-content">
        <div class="activity-feed" id="activity-feed">
          <% @statistics.recent_activities(10).each do |activity| %>
          <div class="activity-item <%= activity[:type] %>">
            <div class="activity-icon">
              <i class="icon-<%= activity[:type] %>"></i>
            </div>
            <div class="activity-content">
              <div class="activity-description"><%= activity[:description] %></div>
              <div class="activity-meta">
                <span class="user"><%= activity[:user] %></span>
                <span class="date"><%= time_ago_in_words(activity[:date]) %> ago</span>
              </div>
            </div>
          </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Initialize dashboard with data
  var dashboardData = {
    project: '<%= @current_project&.name || 'All Projects' %>',
    projectId: '<%= @current_project&.id %>',
    issuesByStatus: <%= chart_data_to_json(@statistics.issues_by_status) %>,
    issuesByPriority: <%= chart_data_to_json(@statistics.issues_by_priority) %>,
    issuesByTracker: <%= chart_data_to_json(@statistics.issues_by_tracker) %>,
    timeByActivity: <%= chart_data_to_json(@statistics.time_by_activity) %>,
    timeByUser: <%= chart_data_to_json(@statistics.time_by_user) %>,
    dailyTime: <%= chart_data_to_json(@statistics.daily_time_last_30_days) %>
  };
  
  Dashboard.init(dashboardData);
</script>